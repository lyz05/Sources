<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>作业 - Web程序设计</title>
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!--  Vue.js  -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- LeanCloud -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.7.0/dist/av-live-query-min.js"></script>
    <script type="text/javascript" src="init.js"></script>
</head>

<body>
    <div id="app" class="container">
        <div class="row">
            <div class="col-md-offset-2 col-md-8">
                <h1>
                    Web程序设计<small>答题页面</small>
                </h1>
            </div>
        </div>
        <div class="row">
            <form>
                <selectquestion ref="selectquestion" :seen="seen"></selectquestion>
                <yesnoquestion ref="yesnoquestion" :seen="seen"></yesnoquestion>
                <selectquestions ref="selectquestions" :seen="seen"></selectquestions>
                <result ref="result" :seen="seen" :score="score"></result>
                <div class="form-group">
                    <div class="col-md-offset-2 col-md-8">
                        <button type="button" class="btn btn-primary" @click="sub()">提交</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script type="text/x-template" id="selectquestion">
        <div class="col-md-offset-2 col-md-8">
            <v-title :title="title" :score="score" :seen="seen"></v-title>
            <div v-for="(question, index) in questions">
                <desp :desp="question.desp" :index="index"></desp>
                <div class="radio" v-for="(item, index) in question.items">
                    <label>
                    <input type="radio" v-bind:value="item" v-model="question.useranswer" @change="judgeAnswer(question)">
                    {{ String.fromCharCode(index+65) }}、{{item}}
                </label>
                </div>
                <answer :seen="seen" :isCorrect="question.isCorrect" :useranswer="question.useranswer" :answer="question.answer"></answer>
                <hr>
            </div>
        </div>
    </script>
    <script type="text/x-template" id="yesnoquestion">
        <div class="col-md-offset-2 col-md-8">
            <v-title :title="title" :score="score" :seen="seen"></v-title>
            <div v-for="(question, index) in questions">
                <desp :desp="question.desp" :index="index"></desp>
                <div class="radio">
                    <label class="radio-inline">
                <input type="radio" value="true" v-model="question.useranswer" @change="judgeAnswer(question)"> √
                    </label>
                    <label class="radio-inline">
                <input type="radio" value="false" v-model="question.useranswer" @change="judgeAnswer(question)"> ×
                    </label>
                </div>
                <answer :seen="seen" :isCorrect="question.isCorrect" :useranswer="question.useranswer" :answer="question.answer"></answer>
                <hr>
            </div>
        </div>
    </script>
    <script type="text/x-template" id="selectquestions">
        <div class="col-md-offset-2 col-md-8">
            <v-title :title="title" :score="score" :seen="seen"></v-title>
            <div v-for="(question, index) in questions">
                <desp :desp="question.desp" :index="index"></desp>
                <div class="checkbox" v-for="(item, index) in question.items">
                    <label>
                      <input type="checkbox" v-bind:value="item" v-model="question.useranswer" @change="judgeAnswer(question)">
                      {{ String.fromCharCode(index+65) }}、{{item}}
                    </label>
                </div>
                <answer :seen="seen" :isCorrect="question.isCorrect" :useranswer="question.useranswer" :answer="question.answer"></answer>
                <hr>
            </div>
        </div>
    </script>
    <script type="text/x-template" id="result">
        <div v-if="seen" class="col-md-offset-2 col-md-8 alert alert-success" role="alert">
            最终得分：{{(score()*100).toFixed(2)+"%"}}
        </div>
    </script>
    <script type="text/x-template" id="desp">
        <div>
            {{index+1}}. {{desp}}
        </div>
    </script>
    <script type="text/x-template" id="answer">
        <div v-if="seen" class="alert" v-bind:class="{ 'alert-success': isCorrect ,'alert-danger': !isCorrect}" role="alert">
            我的答案：{{useranswer}} 正确答案：{{answer}}
        </div>
    </script>
    <script type="text/x-template" id="v-title">
        <h3>
            {{title}}
            <small v-if="seen">得分：{{(score*100).toFixed(2)+"%"}}</small>
        </h3>
    </script>
    <script type="text/javascript">
        init();

        function getObject(objectid, vm) {
            const query = new AV.Query('Test');
            query.get(objectid).then((test) => {
                vm.title = test.get('title');
                vm.questions = test.get('questions');
                //randomQuestions
                randomQuestions(vm.questions);
            }, (error) => {
                alert("获取题目失败！可能是网络问题！");
            });
        }

        function newObject(title, questions) {
            const test = new AV.Object('Test');
            test.set('questions', questions);
            test.set('title', title);
            test.save().then((todo) => {
                // 成功保存之后，执行其他逻辑
                console.log(`保存成功。objectId：${todo.id}`);
            }, (error) => {
                // 异常处理
            });
        }

        function randomQuestions(arr) {
            var len = arr.length;
            for (x = 0; x < len; x++) {
                var y = Math.floor(Math.random() * len);
                var tempOption = arr[x];
                Vue.set(arr, x, arr[y]);
                Vue.set(arr, y, tempOption);
            }
        }

        function calcscore(vm) {
            var cnt = 0;
            var ans = vm.questions.length;
            for (i in vm.questions) {
                cnt += vm.questions[i].isCorrect
            }
            vm.score = 1.0 * cnt / ans;
        }

        function isArrayEqual(value1 = [], value2 = []) {
            return value1.sort().toString() === value2.sort().toString();
        }

        Vue.component("v-title", {
            template: '#v-title',
            props: ['title', 'score', 'seen']
        });
        Vue.component("desp", {
            template: '#desp',
            props: ['desp', 'index']
        });
        Vue.component("answer", {
            template: '#answer',
            props: ['seen', 'isCorrect', 'useranswer', 'answer']
        });
        Vue.component("selectquestion", {
            template: '#selectquestion',
            props: ['seen'],
            data() {
                return {
                    title: null,
                    score: NaN,
                    questions: null
                };
            },
            methods: {
                judgeAnswer: function(question) {
                    question.isCorrect = question.useranswer == question.answer;
                    calcscore(this);
                }
            },
            mounted() {
                getObject('5fd73896a4c66d6958e957f3', this);
            }
        });
        Vue.component("yesnoquestion", {
            template: '#yesnoquestion',
            props: ['seen'],
            data() {
                return {
                    title: null,
                    score: NaN,
                    questions: null
                };
            },
            methods: {
                judgeAnswer(question) {
                    question.useranswer = question.useranswer === 'true';
                    question.isCorrect = question.useranswer == question.answer;
                    calcscore(this);
                }
            },
            mounted() {
                getObject('5fd73896a4c66d6958e957f2', this);
            }
        });
        Vue.component("selectquestions", {
            template: '#selectquestions',
            props: ['seen'],
            data() {
                return {
                    title: null,
                    score: NaN,
                    questions: null
                };
            },
            methods: {
                judgeAnswer(question) {
                    question.isCorrect = isArrayEqual(question.useranswer, question.answer);
                    calcscore(this);
                }
            },
            mounted() {
                getObject('5fd73896a4c66d6958e957f4', this);
            }
        });
        Vue.component("result", {
            template: '#result',
            props: ['seen', 'score']
        });
        var vm = new Vue({
            el: "#app",
            data: {
                seen: true
            },
            methods: {
                sub() {
                    if (isNaN(this.score())) {
                        alert("请答完所有题目，再点击提交哦！");
                    } else {
                        this.seen = true;
                    }
                },
                score() {
                    return 1.0 * (this.$refs.selectquestion.score + this.$refs.yesnoquestion.score + this.$refs.selectquestions.score) / 3;
                }
            }
        });
        // newObject("选择题", vm1.questions);5fd73896a4c66d6958e957f3
        // newObject("判断题", vm2.questions);5fd73896a4c66d6958e957f2
        // newObject("多选题", vm3.questions);5fd73896a4c66d6958e957f4
    </script>

</html>